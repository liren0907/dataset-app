// -----------------------------------------------------------------------------
// Mock Data Store (Generated by Rust Tool)
// -----------------------------------------------------------------------------
// @ts-ignore - JSON imports
import MOCK_IMAGES_DATA from "./generated/mock_images.json";
// @ts-ignore - JSON imports
import MOCK_ANNOTATIONS_DATA from "./generated/mock_annotations.json";

// Typed aliases
const MOCK_IMAGES = (MOCK_IMAGES_DATA as any).images || [];
const MOCK_ANNOTATIONS = (MOCK_ANNOTATIONS_DATA as any).annotated_images || [];

export const MOCK_DIRECTORY_PATH = "mock_data/dataset_bounding_box";

// -----------------------------------------------------------------------------
// Mock Implementation
// -----------------------------------------------------------------------------

export async function mockGetImages(directoryPath: string): Promise<any[]> {
    console.log(`[MOCK] Reading directory: ${directoryPath}`);
    // Simulate network delay
    await new Promise(resolve => setTimeout(resolve, 500));

    // Convert absolute backend paths to relative frontend paths
    // Backend path: /Users/.../mock_data/dataset_bounding_box/filename.jpg
    // Frontend path: /mock_data/dataset_bounding_box/filename.jpg
    const relativeImages = MOCK_IMAGES.map((img: any) => {
        const filename = img.name;
        // In browser dev, static files are at root
        const src = `/mock_data/dataset_bounding_box/${filename}`;

        return {
            ...img,
            path: src, // Use web path for 'path' in browser mode to display images
            assetUrl: src,
            previewUrl: src,
            // Add a flag to identify original backend path if needed for matching
            _backendPath: img.path
        };
    });

    return relativeImages;
}

export async function mockReadTextFile(filePath: string): Promise<string> {
    console.log(`[MOCK] Reading file: ${filePath}`);
    throw new Error("mockReadTextFile not implemented for bulk JSON. Use mockGeneratePreview.");
}

export async function mockGeneratePreview(path: string): Promise<string> {
    console.log(`[MOCK] Generating preview for: ${path}`);
    await new Promise(resolve => setTimeout(resolve, 200));

    // 'path' here is the one from processed images. 
    // If we changed it to web path in mockGetImages, we need to match by filename.
    const filename = path.split('/').pop() || "";

    // Find in generated annotations
    const annotationData = MOCK_ANNOTATIONS.find((item: any) => item.path.endsWith(filename));

    if (annotationData && annotationData.has_json) {
        // Transform backend Annotation Result to LabelMe-like metadata
        const labelMeLike = {
            shapes: annotationData.annotations.map((ann: any) => ({
                label: ann.label,
                shape_type: ann.shape_type,
                points: ann.points
            })),
            imagePath: filename,
            imageHeight: 0, // Mock unknowns
            imageWidth: 0
        };

        return JSON.stringify({
            annotation_metadata: labelMeLike
        });
    }

    return JSON.stringify({ annotation_metadata: { shapes: [] } });
}
